name: Veracode Test
on: [push, pull_request]

jobs:
  Build:
    name: Maeven build
    runs-on: self-hosted
    container:
      image: maven:3.9.6-eclipse-temurin-17
      options: --user root
    steps:
      - name: Checkout https://github.com/${{ github.repository }}@${{ github.ref }}
        uses: actions/checkout@v4
        with:
          persist-credentials: false
      - name: Maeven build
        run: |
          mvn package -DskipTests
          ls -l
      - name: Upload artfacts
        uses: actions/upload-artifact@v3
        with:
          name: artfacts
          path: .

  Veracode-SAST-Pipeline:
    name: Veracode SAST Pipeline
    # if: ${{ github.ref == 'refs/heads/development' }}
    runs-on: self-hosted
    needs: [Build]
    strategy:
      fail-fast: true
    env:
      TARGET_FILE_NAME: target/api-0.0.1-SNAPSHOT.jar
      APPLICATION_NAME: java-maeven-test
      POLICY_NAME: Veracode Recommended Medium
    container:
      image: veracode/pipeline-scan:latest
      options: --user root

    steps:
      - name: Download
        uses: actions/download-artifact@v3
        with:
          name: artfacts
          path: .

      - name: Scan
        run: |
          # zip -r -v ${{ env.TARGET_FILE_NAME }} . -i '*.js' '*.html'
          java -jar /opt/veracode/pipeline-scan.jar -vid "${{ secrets.VERACODE_ID }}" -vkey "${{ secrets.VERACODE_KEY }}" -f ${{ env.TARGET_FILE_NAME }} -p "${{ env.APPLICATION_NAME }}" -pn "${{ env.POLICY_NAME }}"
        continue-on-error: true

      - name: save filtered results file
        uses: actions/upload-artifact@v3
        with:
          name: filtered-results
          path: filtered_results.json
          # -action UploadAndScan -sandboxname "${{ github.ref }}" -createprofile false -version "${{ github.run_id }}"

  Import_Pipeline_Scan_Issues:
    needs: Veracode-SAST-Pipeline
    runs-on: self-hosted
    steps:
      - name: get scan results
        uses: actions/download-artifact@v3
        with:
          name: filtered-results

      - name: import flaws as issues
        uses: buzzcode/veracode-flaws-to-issues@v1
        with:
          scan-results-json: 'filtered_results.json'
          github-token: ${{ secrets.TOKEN_GITHUB }}

  Veracode-SAST-Sandbox:
    name: Veracode SAST Sandbox
    if: ${{ github.ref == 'refs/heads/development' }}
    runs-on: self-hosted
    needs: [Build]
    strategy:
      fail-fast: true
    env:
      TARGET_FILE_NAME: target/api-0.0.1-SNAPSHOT.jar
      APPLICATION_NAME: java-maeven-test
    container:
      image: veracode/api-wrapper-java:latest
      options: --user root

    steps:
      - name: Download
        uses: actions/download-artifact@v3
        with:
          name: artfacts
          path: .

      - name: Scan
        run: |
          # zip -r -v ${{ env.TARGET_FILE_NAME }} . -i '*.js' '*.html'
          java -jar /opt/veracode/api-wrapper.jar -vid "${{ secrets.VERACODE_ID }}" -vkey "${{ secrets.VERACODE_KEY }}" -action UploadAndScan -sandboxname "${{ github.ref }}" -createprofile true -appname "${{ env.APPLICATION_NAME }}" -version "${{ github.run_id }}" -filepath ${{ env.TARGET_FILE_NAME }}
        continue-on-error: true

  Veracode-SAST-Policy:
    name: Veracode SAST Policy
    if: ${{ github.ref == 'refs/heads/main' }}
    runs-on: self-hosted
    needs: [Build]
    strategy:
      fail-fast: true
    env:
      TARGET_FILE_NAME: target/api-0.0.1-SNAPSHOT.jar
      APPLICATION_NAME: java-maeven-test
    container:
      image: veracode/api-wrapper-java:latest
      options: --user root

    steps:
      - name: Download
        uses: actions/download-artifact@v3
        with:
          name: artfacts
          path: .

      - name: Scan
        run: |
          # zip -r -v ${{ env.TARGET_FILE_NAME }} . -i '*.js' '*.html'
          java -jar /opt/veracode/api-wrapper.jar -vid "${{ secrets.VERACODE_ID }}" -vkey "${{ secrets.VERACODE_KEY }}" -action UploadAndScan -sandboxname "${{ github.ref }}" -createprofile true -appname "${{ env.APPLICATION_NAME }}" -version "${{ github.run_id }}" -filepath ${{ env.TARGET_FILE_NAME }}
        continue-on-error: true